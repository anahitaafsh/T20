{"ast":null,"code":"/*! @azure/msal-browser v2.16.0 2021-07-22 */\n'use strict';\n\nimport { __awaiter, __generator } from '../_virtual/_tslib.js';\nimport { BrowserAuthError } from '../error/BrowserAuthError.js';\n/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\n\n/**\r\n * Storage wrapper for IndexedDB storage in browsers: https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API\r\n */\n\nvar DatabaseStorage =\n/** @class */\nfunction () {\n  function DatabaseStorage(dbName, tableName, version) {\n    this.dbName = dbName;\n    this.tableName = tableName;\n    this.version = version;\n    this.dbOpen = false;\n  }\n  /**\r\n   * Opens IndexedDB instance.\r\n   */\n\n\n  DatabaseStorage.prototype.open = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        return [2\n        /*return*/\n        , new Promise(function (resolve, reject) {\n          // TODO: Add timeouts?\n          var openDB = window.indexedDB.open(_this.dbName, _this.version);\n          openDB.addEventListener(\"upgradeneeded\", function (e) {\n            var event = e;\n            event.target.result.createObjectStore(_this.tableName);\n          });\n          openDB.addEventListener(\"success\", function (e) {\n            var event = e;\n            _this.db = event.target.result;\n            _this.dbOpen = true;\n            resolve();\n          });\n          openDB.addEventListener(\"error\", function (error) {\n            return reject(error);\n          });\n        })];\n      });\n    });\n  };\n  /**\r\n   * Retrieves item from IndexedDB instance.\r\n   * @param key\r\n   */\n\n\n  DatabaseStorage.prototype.get = function (key) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (!!this.dbOpen) return [3\n            /*break*/\n            , 2];\n            return [4\n            /*yield*/\n            , this.open()];\n\n          case 1:\n            _a.sent();\n\n            _a.label = 2;\n\n          case 2:\n            return [2\n            /*return*/\n            , new Promise(function (resolve, reject) {\n              // TODO: Add timeouts?\n              if (!_this.db) {\n                return reject(BrowserAuthError.createDatabaseNotOpenError());\n              }\n\n              var transaction = _this.db.transaction([_this.tableName], \"readonly\");\n\n              var objectStore = transaction.objectStore(_this.tableName);\n              var dbGet = objectStore.get(key);\n              dbGet.addEventListener(\"success\", function (e) {\n                var event = e;\n                resolve(event.target.result);\n              });\n              dbGet.addEventListener(\"error\", function (e) {\n                return reject(e);\n              });\n            })];\n        }\n      });\n    });\n  };\n  /**\r\n   * Adds item to IndexedDB under given key\r\n   * @param key\r\n   * @param payload\r\n   */\n\n\n  DatabaseStorage.prototype.put = function (key, payload) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (!!this.dbOpen) return [3\n            /*break*/\n            , 2];\n            return [4\n            /*yield*/\n            , this.open()];\n\n          case 1:\n            _a.sent();\n\n            _a.label = 2;\n\n          case 2:\n            return [2\n            /*return*/\n            , new Promise(function (resolve, reject) {\n              // TODO: Add timeouts?\n              if (!_this.db) {\n                return reject(BrowserAuthError.createDatabaseNotOpenError());\n              }\n\n              var transaction = _this.db.transaction([_this.tableName], \"readwrite\");\n\n              var objectStore = transaction.objectStore(_this.tableName);\n              var dbPut = objectStore.put(payload, key);\n              dbPut.addEventListener(\"success\", function (e) {\n                var event = e;\n                resolve(event.target.result);\n              });\n              dbPut.addEventListener(\"error\", function (e) {\n                return reject(e);\n              });\n            })];\n        }\n      });\n    });\n  };\n\n  return DatabaseStorage;\n}();\n\nexport { DatabaseStorage };","map":{"version":3,"mappings":"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","names":["dbName","tableName","version","dbOpen","DatabaseStorage","Promise","resolve","reject","openDB","window","indexedDB","open","_this","addEventListener","e","event","target","result","createObjectStore","db","error","key","_a","BrowserAuthError","createDatabaseNotOpenError","transaction","objectStore","dbGet","get","payload","dbPut","put"],"sources":["../../src/cache/DatabaseStorage.ts"],"sourcesContent":["/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { BrowserAuthError } from \"../error/BrowserAuthError\";\r\n\r\ninterface IDBOpenDBRequestEvent extends Event {\r\n    target: IDBOpenDBRequest & EventTarget;\r\n}\r\n\r\ninterface IDBOpenOnUpgradeNeededEvent extends IDBVersionChangeEvent {\r\n    target: IDBOpenDBRequest & EventTarget;\r\n}\r\n\r\ninterface IDBRequestEvent extends Event {\r\n    target: IDBRequest & EventTarget;\r\n}\r\n\r\n/**\r\n * Storage wrapper for IndexedDB storage in browsers: https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API\r\n */\r\nexport class DatabaseStorage<T>{\r\n    private db: IDBDatabase|undefined;\r\n    private dbName: string;\r\n    private tableName: string;\r\n    private version: number;\r\n    private dbOpen: boolean;\r\n\r\n    constructor(dbName: string, tableName: string, version: number) {\r\n        this.dbName = dbName;\r\n        this.tableName = tableName;\r\n        this.version = version;\r\n        this.dbOpen = false;\r\n    }\r\n\r\n    /**\r\n     * Opens IndexedDB instance.\r\n     */\r\n    async open(): Promise<void> {\r\n        return new Promise((resolve, reject) => {\r\n            // TODO: Add timeouts?\r\n            const openDB = window.indexedDB.open(this.dbName, this.version);\r\n            openDB.addEventListener(\"upgradeneeded\", (e: IDBVersionChangeEvent) => {\r\n                const event = e as IDBOpenOnUpgradeNeededEvent;\r\n                event.target.result.createObjectStore(this.tableName);\r\n            });\r\n            openDB.addEventListener(\"success\", (e: Event) => {\r\n                const event = e as IDBOpenDBRequestEvent;\r\n                this.db = event.target.result;\r\n                this.dbOpen = true;\r\n                resolve();\r\n            });\r\n\r\n            openDB.addEventListener(\"error\", error => reject(error));\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Retrieves item from IndexedDB instance.\r\n     * @param key \r\n     */\r\n    async get(key: string): Promise<T> {\r\n        if (!this.dbOpen) {\r\n            await this.open();\r\n        }\r\n\r\n        return new Promise<T>((resolve, reject) => {\r\n            // TODO: Add timeouts?\r\n            if (!this.db) {\r\n                return reject(BrowserAuthError.createDatabaseNotOpenError());\r\n            }\r\n\r\n            const transaction = this.db.transaction([this.tableName], \"readonly\");\r\n\r\n            const objectStore = transaction.objectStore(this.tableName);\r\n            const dbGet = objectStore.get(key);\r\n            dbGet.addEventListener(\"success\", (e: Event) => {\r\n                const event = e as IDBRequestEvent;\r\n                resolve(event.target.result);\r\n            });\r\n            dbGet.addEventListener(\"error\", e => reject(e));\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Adds item to IndexedDB under given key\r\n     * @param key \r\n     * @param payload \r\n     */\r\n    async put(key: string, payload: T): Promise<T> {\r\n        if (!this.dbOpen) {\r\n            await this.open();\r\n        }\r\n\r\n        return new Promise<T>((resolve: Function, reject: Function) => {\r\n            // TODO: Add timeouts?\r\n            if (!this.db) {\r\n                return reject(BrowserAuthError.createDatabaseNotOpenError());\r\n            }\r\n\r\n            const transaction = this.db.transaction([this.tableName], \"readwrite\");\r\n            const objectStore = transaction.objectStore(this.tableName);\r\n\r\n            const dbPut = objectStore.put(payload, key);\r\n            dbPut.addEventListener(\"success\", (e: Event) => {\r\n                const event = e as IDBRequestEvent;\r\n                resolve(event.target.result);\r\n            });\r\n            dbPut.addEventListener(\"error\", e => reject(e));\r\n        });\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}