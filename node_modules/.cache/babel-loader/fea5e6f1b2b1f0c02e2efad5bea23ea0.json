{"ast":null,"code":"/*! @azure/msal-common v4.5.0 2021-07-22 */\n'use strict';\n\nimport { ThrottlingConstants, CacheSchemaType, Constants as Constants$1, HeaderNames } from '../utils/Constants.js';\nimport { ServerError as ServerError$1 } from '../error/ServerError.js';\n/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\n\nvar ThrottlingUtils =\n/** @class */\nfunction () {\n  function ThrottlingUtils() {}\n  /**\r\n   * Prepares a RequestThumbprint to be stored as a key.\r\n   * @param thumbprint\r\n   */\n\n\n  ThrottlingUtils.generateThrottlingStorageKey = function (thumbprint) {\n    return ThrottlingConstants.THROTTLING_PREFIX + \".\" + JSON.stringify(thumbprint);\n  };\n  /**\r\n   * Performs necessary throttling checks before a network request.\r\n   * @param cacheManager\r\n   * @param thumbprint\r\n   */\n\n\n  ThrottlingUtils.preProcess = function (cacheManager, thumbprint) {\n    var _a;\n\n    var key = ThrottlingUtils.generateThrottlingStorageKey(thumbprint);\n    var value = cacheManager.getThrottlingCache(key);\n\n    if (value) {\n      if (value.throttleTime < Date.now()) {\n        cacheManager.removeItem(key, CacheSchemaType.THROTTLING);\n        return;\n      }\n\n      throw new ServerError$1(((_a = value.errorCodes) === null || _a === void 0 ? void 0 : _a.join(\" \")) || Constants$1.EMPTY_STRING, value.errorMessage, value.subError);\n    }\n  };\n  /**\r\n   * Performs necessary throttling checks after a network request.\r\n   * @param cacheManager\r\n   * @param thumbprint\r\n   * @param response\r\n   */\n\n\n  ThrottlingUtils.postProcess = function (cacheManager, thumbprint, response) {\n    if (ThrottlingUtils.checkResponseStatus(response) || ThrottlingUtils.checkResponseForRetryAfter(response)) {\n      var thumbprintValue = {\n        throttleTime: ThrottlingUtils.calculateThrottleTime(parseInt(response.headers[HeaderNames.RETRY_AFTER])),\n        error: response.body.error,\n        errorCodes: response.body.error_codes,\n        errorMessage: response.body.error_description,\n        subError: response.body.suberror\n      };\n      cacheManager.setThrottlingCache(ThrottlingUtils.generateThrottlingStorageKey(thumbprint), thumbprintValue);\n    }\n  };\n  /**\r\n   * Checks a NetworkResponse object's status codes against 429 or 5xx\r\n   * @param response\r\n   */\n\n\n  ThrottlingUtils.checkResponseStatus = function (response) {\n    return response.status === 429 || response.status >= 500 && response.status < 600;\n  };\n  /**\r\n   * Checks a NetworkResponse object's RetryAfter header\r\n   * @param response\r\n   */\n\n\n  ThrottlingUtils.checkResponseForRetryAfter = function (response) {\n    if (response.headers) {\n      return response.headers.hasOwnProperty(HeaderNames.RETRY_AFTER) && (response.status < 200 || response.status >= 300);\n    }\n\n    return false;\n  };\n  /**\r\n   * Calculates the Unix-time value for a throttle to expire given throttleTime in seconds.\r\n   * @param throttleTime\r\n   */\n\n\n  ThrottlingUtils.calculateThrottleTime = function (throttleTime) {\n    var time = throttleTime <= 0 ? 0 : throttleTime;\n    var currentSeconds = Date.now() / 1000;\n    return Math.floor(Math.min(currentSeconds + (time || ThrottlingConstants.DEFAULT_THROTTLE_TIME_SECONDS), currentSeconds + ThrottlingConstants.DEFAULT_MAX_THROTTLE_TIME_SECONDS) * 1000);\n  };\n\n  ThrottlingUtils.removeThrottle = function (cacheManager, clientId, authority, scopes, homeAccountIdentifier) {\n    var thumbprint = {\n      clientId: clientId,\n      authority: authority,\n      scopes: scopes,\n      homeAccountIdentifier: homeAccountIdentifier\n    };\n    var key = this.generateThrottlingStorageKey(thumbprint);\n    return cacheManager.removeItem(key, CacheSchemaType.THROTTLING);\n  };\n\n  return ThrottlingUtils;\n}();\n\nexport { ThrottlingUtils };","map":{"version":3,"mappings":"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","names":["ThrottlingUtils","thumbprint","ThrottlingConstants","THROTTLING_PREFIX","JSON","stringify","cacheManager","key","generateThrottlingStorageKey","value","getThrottlingCache","throttleTime","Date","now","removeItem","CacheSchemaType","THROTTLING","ServerError","errorCodes","_a","join","Constants","EMPTY_STRING","errorMessage","subError","response","checkResponseStatus","checkResponseForRetryAfter","thumbprintValue","calculateThrottleTime","parseInt","headers","HeaderNames","RETRY_AFTER","error","body","error_codes","error_description","suberror","setThrottlingCache","status","hasOwnProperty","time","currentSeconds","Math","floor","min","DEFAULT_THROTTLE_TIME_SECONDS","DEFAULT_MAX_THROTTLE_TIME_SECONDS","clientId","authority","scopes","homeAccountIdentifier"],"sources":["../../src/network/ThrottlingUtils.ts"],"sourcesContent":["/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { NetworkResponse } from \"./NetworkManager\";\r\nimport { ServerAuthorizationTokenResponse } from \"../response/ServerAuthorizationTokenResponse\";\r\nimport { HeaderNames, CacheSchemaType, ThrottlingConstants, Constants } from \"../utils/Constants\";\r\nimport { CacheManager } from \"../cache/CacheManager\";\r\nimport { ServerError } from \"../error/ServerError\";\r\nimport { RequestThumbprint } from \"./RequestThumbprint\";\r\nimport { ThrottlingEntity } from \"../cache/entities/ThrottlingEntity\";\r\n\r\nexport class ThrottlingUtils {\r\n\r\n    /**\r\n     * Prepares a RequestThumbprint to be stored as a key.\r\n     * @param thumbprint\r\n     */\r\n    static generateThrottlingStorageKey(thumbprint: RequestThumbprint): string {\r\n        return `${ThrottlingConstants.THROTTLING_PREFIX}.${JSON.stringify(thumbprint)}`;\r\n    }\r\n\r\n    /**\r\n     * Performs necessary throttling checks before a network request.\r\n     * @param cacheManager\r\n     * @param thumbprint\r\n     */\r\n    static preProcess(cacheManager: CacheManager, thumbprint: RequestThumbprint): void {\r\n        const key = ThrottlingUtils.generateThrottlingStorageKey(thumbprint);\r\n        const value = cacheManager.getThrottlingCache(key);\r\n\r\n        if (value) {\r\n            if (value.throttleTime < Date.now()) {\r\n                cacheManager.removeItem(key, CacheSchemaType.THROTTLING);\r\n                return;\r\n            }\r\n            throw new ServerError(value.errorCodes?.join(\" \") || Constants.EMPTY_STRING, value.errorMessage, value.subError);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Performs necessary throttling checks after a network request.\r\n     * @param cacheManager\r\n     * @param thumbprint\r\n     * @param response\r\n     */\r\n    static postProcess(cacheManager: CacheManager, thumbprint: RequestThumbprint, response: NetworkResponse<ServerAuthorizationTokenResponse>): void {\r\n        if (ThrottlingUtils.checkResponseStatus(response) || ThrottlingUtils.checkResponseForRetryAfter(response)) {\r\n            const thumbprintValue: ThrottlingEntity = {\r\n                throttleTime: ThrottlingUtils.calculateThrottleTime(parseInt(response.headers[HeaderNames.RETRY_AFTER])),\r\n                error: response.body.error,\r\n                errorCodes: response.body.error_codes,\r\n                errorMessage: response.body.error_description,\r\n                subError: response.body.suberror\r\n            };\r\n            cacheManager.setThrottlingCache(\r\n                ThrottlingUtils.generateThrottlingStorageKey(thumbprint),\r\n                thumbprintValue\r\n            );\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Checks a NetworkResponse object's status codes against 429 or 5xx\r\n     * @param response\r\n     */\r\n    static checkResponseStatus(response: NetworkResponse<ServerAuthorizationTokenResponse>): boolean {\r\n        return response.status === 429 || response.status >= 500 && response.status < 600;\r\n    }\r\n\r\n    /**\r\n     * Checks a NetworkResponse object's RetryAfter header\r\n     * @param response\r\n     */\r\n    static checkResponseForRetryAfter(response: NetworkResponse<ServerAuthorizationTokenResponse>): boolean {\r\n        if (response.headers) {\r\n            return response.headers.hasOwnProperty(HeaderNames.RETRY_AFTER) && (response.status < 200 || response.status >= 300);\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Calculates the Unix-time value for a throttle to expire given throttleTime in seconds.\r\n     * @param throttleTime\r\n     */\r\n    static calculateThrottleTime(throttleTime: number): number {\r\n        const time = throttleTime <= 0 ? 0 : throttleTime;\r\n\r\n        const currentSeconds = Date.now() / 1000;\r\n        return Math.floor(Math.min(\r\n            currentSeconds + (time || ThrottlingConstants.DEFAULT_THROTTLE_TIME_SECONDS),\r\n            currentSeconds + ThrottlingConstants.DEFAULT_MAX_THROTTLE_TIME_SECONDS\r\n        ) * 1000);\r\n    }\r\n\r\n    static removeThrottle(cacheManager: CacheManager, clientId: string, authority: string, scopes: Array<string>, homeAccountIdentifier?: string): boolean {\r\n        const thumbprint: RequestThumbprint = {\r\n            clientId,\r\n            authority,\r\n            scopes,\r\n            homeAccountIdentifier\r\n        };\r\n\r\n        const key = this.generateThrottlingStorageKey(thumbprint);\r\n        return cacheManager.removeItem(key, CacheSchemaType.THROTTLING);\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}